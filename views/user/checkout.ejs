<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Eternal Chapters</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="userDetails.css" />
    <link rel="stylesheet" href="cart.css" />
    <link rel="stylesheet" href="user/header.css" />
    <link rel="stylesheet" href="user/checkout.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
</head>
<body>
    <%- include('../../views/partials/user/detailsHeader') %>

    <div class="d-flex main containers">
        <div class="main-content container mt-5 cart-container">
            <h4 class="mb-4 ms-2">Select delivery address</h4>

            <div id="notification" style="display: none"></div>

            <!-- Form for Address and Payment -->
            <form id="checkout-form" action="/place-order" method="POST">
                <div class="row item-card">
                    <!-- Left Section: Address list -->
                    <div class="col-md-8">
                        <div class="add-div">
                            <% addresses.forEach(address => { %>
                            <div class="row align-items-center mb-3 address-card">
                                <div class="col-12">
                                    <label class="form-check-label d-flex align-items-center position-relative">
                                        <input type="radio" name="addressId" class="form-check-input me-2 add-radio" value="<%= address.id %>" />
                                        <div class="address">
                                            <h5><%= address.name %></h5>
                                            <h6><%= address.city %></h6>
                                            <p><%= address.state %></p>
                                            <p class="text-success fw-bold"><%= address.address_type %></p>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            <% }) %>
                        </div>
                        <a class="text-decoration-none text-dark btn btn-primary mt-3 text-white" href="/addAddress?from=checkout">Add address</a>

                        <div class="coupon-section mt-4 bg">
                            <h4 class="mb-3">Apply Coupon</h4>
                            <input type="text" id="coupon-code" class="form-control" placeholder="Enter coupon code" />
                            <button type="button" id="apply-coupon" class="btn btn-success mt-2">Apply Coupon</button>
                            <div id="coupon-message" class="mt-2 text-danger"></div>
                        </div>

                        <!-- Payment Methods Section -->
                        <div class="payment-methods mt-4">
                            <h4 class="mb-3">Payment Methods</h4>
                            <p>Select any payment method</p>
                            <div>
                                <label class="form-check">
                                    <input type="radio" name="paymentMethod" value="creditCard" class="form-check-input" /> Debit Card / Credit Card
                                </label>
                                <label class="form-check mt-2">
                                    <input type="radio" name="paymentMethod" value="bank" class="form-check-input" /> Bank
                                </label>
                                <label class="form-check mt-2">
                                    <input type="radio" name="paymentMethod" value="upi" class="form-check-input" /> UPI Method
                                </label>
                                <label class="form-check mt-2">
                                    <input type="radio" name="paymentMethod" value="COD" class="form-check-input" /> Cash on Delivery
                                    <input type="hidden" name="razorpayPaymentId" id="payment_id" />
                                </label>
                                <input type="hidden" name="productId" value="<%= cart.items[0].product_id._id %>" />
                            </div>
                        </div>
                    </div>

                    <!-- Right Section: Price Details -->
                    <div class="col-md-4 price-holder">
                        <div class="price-details">
                            <h5>PRICE DETAILS</h5>
                            <p>Price ( <%= cart.items.length %> Items ) <span class="float-end">&#8377;<%= totalAmount %></span></p>
                            <p>Delivery Charges <span class="float-end">&#8377;<%= shippingCharges %></span></p>
                            <hr />
                            <p class="fw-bold">Total Amount <span class="float-end total">&#8377;<%= netAmount %></span></p>
                            <button type="submit" class="btn-checkout w-100 mt-3">Place Order</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Footer -->
    <%- include('../../views/partials/user/detailsFooter') %>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <script>


        document.querySelector('#checkout-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            // Check if an address is selected
            const selectedAddress = document.querySelector('input[name="addressId"]:checked');
            if (!selectedAddress) {
                Swal.fire({
                    title: "Error!",
                    text: "Please select a delivery address.",
                    icon: "error",
                    showConfirmButton: true
                });
                return;
            }

            const selectedPaymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            if (selectedPaymentMethod === 'COD') {
                this.submit();
                return;
            }

            const amountElement = document.querySelector('.total');
            const amount = parseFloat(amountElement.textContent.replace('₹', ''));  

            try {
                const response = await fetch('/create-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount })
                });

                const data = await response.json();
                if (!data.success) {
                    Swal.fire({
                        title: "Error!",
                        text: "Failed to create order. Please try again.",
                        icon: "error",
                        showConfirmButton: false,
                        timer: 2000
                    });
                    return;
                }

                const options = {
                    key: '<%= process.env.RAZORPAY_KEY_ID %>',
                    amount: data.amount,
                    currency: data.currency,
                    name: 'Eternal Chapters',
                    description: 'Test Transaction',
                    image: '/path/to/logo.png',
                    order_id: data.order_id,
                    handler: function (response) {
                        Swal.fire({
                            title: "Success!",
                            text: "Payment successful!",
                            icon: "success",
                            showConfirmButton: false,
                            timer: 2000
                        }).then(() => {
                            // Submit the form after successful payment
                            const form = document.querySelector('#checkout-form');
                            document.getElementById('payment_id').value = response.razorpay_payment_id;
                            form.submit();
                        });
                    },
                    prefill: {
                        name: '<%= user.name %>',
                        email: '<%= user.email %>',
                        contact: '<%= user.phone %>'
                    },
                    theme: { color: '#3399cc' }
                };

                const rzp1 = new Razorpay(options);
                rzp1.open();
            } catch (error) {
                Swal.fire({
                    title: "Error!",
                    text: "An error occurred. Please try again.",
                    icon: "error",
                    showConfirmButton: false,
                    timer: 2000
                });
            }
        });

        document.getElementById('apply-coupon').addEventListener('click', async function() {
            const couponCode = document.getElementById('coupon-code').value;

            if(!couponCode) {
                document.getElementById('coupon-message').innerHTML = "Please enter a coupon code!"
                return
            }

            try {
                const response = await fetch('/apply-coupon', {
                    method: 'POST',
                    headers: {'Content-type' : 'application/json'},
                    body: JSON.stringify({couponCode})
                })

                const data = await response.json()

                if(data.success) {
                    document.getElementById('coupon-message').innerHTML = `Coupn applied! discount: ₹${data.discountAmount}`;
                    //update the total amount displayed on the page
                    document.querySelector('.total').innerHTML = `₹${data.newTotalAmount}`
                } else {
                    document.getElementById('coupon-message').innerHTML = data.message
                }
            } catch (error) {
                Swal.fire({
                    title: 'Error',
                    text: error.message,
                    icon: 'error',
                    showConfirmButton: false,
                    timer: 2000
                })
            }
        })
    </script>

    <% if (error && error.length > 0) { %>
      <script>
        Swal.fire({
          title: "Error!",
          text: "<%= error[0] %>", // Display the success message
          icon: "error",
          showConfirmButton: false,
          timer: 2000,
          customClass: {
            popup: "my-swal-popup", // Custom class for the popup
            title: "my-swal-title", // Custom class for the title
            content: "my-swal-content", // Custom class for the content (text)
            confirmButton: "my-swal-btn", // Custom class for the button
          },
        });
      </script>
    <% } %>
    <% if (success && success.length > 0) { %>
      <script>
        Swal.fire({
          icon: "success",
          title: "Success!",
          text: "<%= success[0] %>", // Display the first success message
          showConfirmButton: false,
          timer: 1500,
          customClass: {
            popup: "my-swal-popup", // Custom class for the popup
            title: "my-swal-title", // Custom class for the title
            content: "my-swal-content", // Custom class for the content (text)
            confirmButton: "my-swal-btn", // Custom class for the button
          },
        });
      </script>
    <% } %>
</body>
</html>